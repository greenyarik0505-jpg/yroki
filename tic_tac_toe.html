<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ (–° –≤—ã–±–æ—Ä–æ–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏)</title>
    
    <style>
        /* --- CSS –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¢–ï–ú --- */
        :root {
            /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            --color-bg: #1e1e2e; 
            --color-surface: #313244; 
            --color-card: #45475a; 
            --color-text: #cdd6f4; 
            --color-text-subtle: #6c7086;
            --color-accent: #89b4fa;
            --color-success: #a6e3a1; 
            --color-x: #f38ba8; 
            --color-o: #fab387; 
            --color-win-bg: #a6e3a1; 
            --color-win-text: #1e1e2e;
            --color-move-flash: rgba(255, 255, 255, 0.3);
            --color-hover-ghost: rgba(255, 255, 255, 0.1);
            --color-progress: #89b4fa; 
            --color-score-x: var(--color-x);
            --color-score-draw: var(--color-accent);
            --color-score-o: var(--color-o);
            --modal-bg: #1e1e2e;
        }

        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
        body.light-theme {
            --color-bg: #eff1f5;
            --color-surface: #e6e9ef;
            --color-card: #d9e0ee;
            --color-text: #4c4f69;
            --color-text-subtle: #727b95;
            --color-accent: #1e66f5;
            --color-success: #40a02b;
            --color-x: #d20f39;
            --color-o: #fe640b;
            --color-win-bg: #40a02b;
            --color-win-text: #eff1f5;
            --color-move-flash: rgba(0, 0, 0, 0.15);
            --color-hover-ghost: rgba(0, 0, 0, 0.05);
            --color-progress: #1e66f5;
            --color-score-x: var(--color-x);
            --color-score-draw: var(--color-accent);
            --color-score-o: var(--color-o);
            --modal-bg: #eff1f5;
        }


        /* --- –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò --- */
        body {
            font-family: 'Inter', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--color-bg); 
            color: var(--color-text); 
            transition: background-color 0.5s, color 0.5s;
        }

        h1 {
            color: var(--color-accent); 
            margin-bottom: 20px;
            font-weight: 800;
        }

        #controls {
            display: flex;
            flex-wrap: wrap; 
            align-items: center;
            justify-content: center;
            gap: 15px 20px;
            margin-bottom: 30px;
            padding: 0 10px;
        }
        
        #difficulty-select {
            padding: 10px 15px;
            font-size: 18px;
            cursor: pointer;
            background-color: var(--color-card); 
            color: var(--color-text);
            border: 2px solid var(--color-accent);
            border-radius: 8px;
            font-weight: 700;
            transition: border-color 0.3s;
        }

        #theme-toggle {
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
            padding: 5px;
            border-radius: 50%;
            transition: transform 0.2s;
            color: var(--color-text);
        }

        #info-bar {
            display: flex;
            gap: 25px;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: 600;
            padding: 10px 20px;
            background-color: var(--color-surface);
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            min-height: 25px;
        }

        #current-player-indicator {
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
            color: var(--color-text);
        }
        
        .player-x-turn { background-color: var(--color-x); }
        .player-o-turn { background-color: var(--color-o); }
        
        #score-display {
            font-size: 18px;
            font-weight: 700;
            padding: 5px 10px;
            background-color: var(--color-card);
            border-radius: 5px;
            cursor: pointer;
        }
        .score-x { color: var(--color-score-x); }
        .score-draw { color: var(--color-score-draw); }
        .score-o { color: var(--color-score-o); }

        /* –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ */
        #leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 16px;
        }
        #leaderboard-table th, #leaderboard-table td {
            padding: 8px;
            border-bottom: 1px solid var(--color-card);
            text-align: center;
        }
        #leaderboard-table th {
            color: var(--color-accent);
        }
        .leaderboard-time {
            font-weight: bold;
            color: var(--color-success);
        }
        .leaderboard-name {
            color: var(--color-x);
        }


        #game-board {
            display: grid;
            grid-template-columns: repeat(3, 110px); 
            grid-template-rows: repeat(3, 110px);
            gap: 10px; 
            background-color: var(--color-surface); 
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            width: fit-content;
            transition: transform 0.1s, opacity 0.5s; 
            opacity: 1; /* –ì–ê–†–ê–ù–¢–ò–†–£–ï–ú –í–ò–î–ò–ú–û–°–¢–¨ */
        }
        
        /* –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∏–ª–∏ fade-in */

        #game-board.vibrate {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .cell {
            background-color: var(--color-card); 
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px; 
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            user-select: none;
            width: 110px; 
            height: 110px;
            pointer-events: auto; 
            position: relative;
            overflow: hidden;
        }
        
        .cell:not([data-player]):hover::after {
            content: attr(data-player-symbol);
            position: absolute;
            font-size: 80px;
            color: var(--color-hover-ghost);
            z-index: 1;
        }

        .cell:not([data-player]):hover {
            background-color: var(--color-card); 
            transform: scale(1.02);
        }
        
        .cell.win {
            background-color: var(--color-win-bg) !important; 
            color: var(--color-win-text) !important; 
            box-shadow: 0 0 20px var(--color-success);
            transform: scale(1.1);
        }

        #message {
            margin-top: 35px;
            font-size: 28px;
            font-weight: 700;
            color: var(--color-success); 
            min-height: 35px;
            transition: color 0.3s;
        }
        
        .status-win {
            color: var(--color-win-bg) !important;
            text-shadow: 0 0 5px var(--color-win-bg);
        }
        .status-draw {
            color: var(--color-accent) !important;
            text-shadow: 0 0 5px var(--color-accent);
        }
        .status-lose { 
            color: var(--color-x) !important; 
            text-shadow: 0 0 5px var(--color-x);
        }
        .status-impossible { 
            color: #74c7ec !important; 
            text-shadow: 0 0 5px #74c7ec;
        }

        button {
            padding: 12px 25px;
            font-size: 18px;
            cursor: pointer;
            background-color: var(--color-accent); 
            color: var(--color-text);
            border: none;
            border-radius: 8px;
            font-weight: 700;
            box-shadow: 0 4px color-mix(in srgb, var(--color-accent) 50%, black);
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.1s;
        }

        button:hover, #theme-toggle:hover, #score-display:hover {
            box-shadow: 0 0 15px var(--color-accent);
            z-index: 2;
        }

        button:active {
            box-shadow: 0 2px color-mix(in srgb, var(--color-accent) 50%, black);
            transform: translateY(2px);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–¥–∞—Ç—å—Å—è" */
        #surrender-button {
            background-color: var(--color-x);
            box-shadow: 0 4px color-mix(in srgb, var(--color-x) 50%, black);
        }
        #surrender-button:hover {
            box-shadow: 0 0 15px var(--color-x);
        }
        #surrender-button:active {
             box-shadow: 0 2px color-mix(in srgb, var(--color-x) 50%, black);
        }

        .cell[data-player] {
            font-family: inherit;
        }
        .cell[data-player="X_P"] {
            color: var(--color-x); 
        }

        .cell[data-player="O_P"] {
            color: var(--color-o); 
        }

        #bot-progress-container {
            height: 8px;
            width: 100%;
            max-width: 370px; 
            background-color: var(--color-card);
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
            display: none; 
        }

        #bot-progress-bar {
            height: 100%;
            width: 0;
            background-color: var(--color-progress);
            transition: width 0.5s linear;
        }
        
        #game-log {
            margin-top: 25px;
            padding: 15px;
            background-color: var(--color-surface);
            border-radius: 10px;
            width: 350px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 14px;
            border: 1px solid var(--color-card);
            color: var(--color-text-subtle);
        }
        #log-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .log-x { color: var(--color-x); }
        .log-o { color: var(--color-o); }


        /* --- –°–¢–ò–õ–ò –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--modal-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            text-align: center;
            color: var(--color-text);
            max-width: 90vw;
            width: 400px;
            border: 1px solid var(--color-accent);
        }
        .modal-content h2 {
            color: var(--color-accent);
            margin-bottom: 25px;
            font-size: 24px;
        }
        .modal-actions button {
            margin: 15px 10px 0;
            min-width: 100px;
        }
        
        #unbeatable-counter-display { 
            margin-top: 20px;
            font-size: 18px;
            font-weight: 700;
            color: #74c7ec;
        }

        /* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 450px) {
            #game-board {
                grid-template-columns: repeat(3, 90px);
                grid-template-rows: repeat(3, 90px);
                gap: 8px;
            }
            .cell {
                width: 90px;
                height: 90px;
                font-size: 60px;
            }
            #game-log {
                width: 90vw;
            }
            #info-bar {
                font-size: 16px;
                gap: 15px;
            }
            #score-display {
                font-size: 16px;
            }
            #controls button {
                padding: 10px 15px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body class="dark-theme">

    <h1>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ (–° –≤—ã–±–æ—Ä–æ–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏)</h1>
    
    <div id="controls">
        <select id="difficulty-select">
            <option value="random">–õ–µ–≥–∫–∏–π (–°–ª—É—á–∞–π–Ω—ã–π)</option>
            <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
            <option value="hard">–°–ª–æ–∂–Ω—ã–π</option>
            <option value="ideal" selected>–ù–µ—Ä–µ–∞–ª—å–Ω—ã–π (–ò–¥–µ–∞–ª—å–Ω—ã–π)</option>
        </select>
        <button id="reset-button">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        <button id="surrender-button">–°–¥–∞—Ç—å—Å—è üè≥Ô∏è</button>
        <button id="reset-score-button">–°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç</button>
        <div id="theme-toggle">üåô</div> 
    </div>

    <div id="bot-progress-container">
        <div id="bot-progress-bar"></div>
    </div>

    <div id="info-bar">
        <span id="current-player-indicator">–•–û–î: X</span>
        <span id="score-display">–°—á–µ—Ç: <span class="score-x">0</span> - <span class="score-draw">0</span> - <span class="score-o">0</span></span>
        <span id="move-counter">–•–æ–¥: 0</span>
        <span id="time-counter">–í—Ä–µ–º—è: 0.0s</span>
    </div>
    
    <div id="game-board">
        <div class="cell" data-index="0"></div>
        <div class="cell" data-index="1"></div>
        <div class="cell" data-index="2"></div>
        <div class="cell" data-index="3"></div>
        <div class="cell" data-index="4"></div>
        <div class="cell" data-index="5"></div>
        <div class="cell" data-index="6"></div>
        <div class="cell" data-index="7"></div>
        <div class="cell" data-index="8"></div>
    </div>

    <div id="message"></div>
    <div id="unbeatable-counter-display">–°–µ—Ä–∏—è –±–µ–∑ –ø–æ—Ä–∞–∂–µ–Ω–∏–π: 0</div>

    <div id="game-log">
        <h3>–ñ—É—Ä–Ω–∞–ª —Ö–æ–¥–æ–≤:</h3>
        <ul id="log-list"></ul>
    </div>

    <div id="stats-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>üèÜ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –†–µ–∫–æ—Ä–¥—ã</h2>
            <p>–ü–æ–±–µ–¥—ã –ò–≥—Ä–æ–∫–∞ (X): <span class="score-x" id="stats-win">0</span></p>
            <p>–ù–∏—á—å–∏: <span class="score-draw" id="stats-draw">0</span></p>
            <p>–ü–æ–±–µ–¥—ã –ë–æ—Ç–∞ (O): <span class="score-o" id="stats-lose">0</span></p>
            <p id="stats-unbeatable">–°–µ—Ä–∏—è –±–µ–∑ –ø–æ—Ä–∞–∂–µ–Ω–∏–π: 0</p>
            
            <hr style="margin: 15px 0; border-color: var(--color-card);">
            <h3>–õ—É—á—à–µ–µ –≤—Ä–µ–º—è –ø–æ–±–µ–¥—ã</h3>
            <table id="leaderboard-table">
                <thead>
                    <tr><th>#</th><th>–í—Ä–µ–º—è</th></tr>
                </thead>
                <tbody id="leaderboard-body">
                    </tbody>
            </table>

            <div class="modal-actions">
                <button id="modal-stats-close">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="confirm-reset-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É –∑–∞–Ω–æ–≤–æ?</h2>
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â—É—é –∏–≥—Ä—É?</p>
            <div class="modal-actions">
                <button id="modal-confirm-yes">–î–∞</button>
                <button id="modal-confirm-no">–ù–µ—Ç</button>
            </div>
        </div>
    </div>

    <div id="confirm-surrender-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>–°–¥–∞—Ç—å—Å—è?</h2>
            <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –∑–∞—Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –ø–æ—Ä–∞–∂–µ–Ω–∏–µ.</p>
            <div class="modal-actions">
                <button id="modal-surrender-yes" style="background-color: var(--color-x);">–î–∞, —Å–¥–∞—é—Å—å</button>
                <button id="modal-surrender-no">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    

    <script>
        // --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        const cells = document.querySelectorAll('.cell');
        const messageDisplay = document.getElementById('message');
        const resetButton = document.getElementById('reset-button');
        const resetScoreButton = document.getElementById('reset-score-button');
        const surrenderButton = document.getElementById('surrender-button'); 
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        const playerIndicator = document.getElementById('current-player-indicator');
        const gameBoardElement = document.getElementById('game-board');
        const logList = document.getElementById('log-list');
        const scoreDisplay = document.getElementById('score-display');
        const unbeatableDisplay = document.getElementById('unbeatable-counter-display'); 
        const progressBarContainer = document.getElementById('bot-progress-container');
        const progressBar = document.getElementById('bot-progress-bar');
        const difficultySelect = document.getElementById('difficulty-select');

        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        const statsModal = document.getElementById('stats-modal');
        const confirmResetModal = document.getElementById('confirm-reset-modal');
        const confirmSurrenderModal = document.getElementById('confirm-surrender-modal'); 
        const modalConfirmYes = document.getElementById('modal-confirm-yes');
        const modalConfirmNo = document.getElementById('modal-confirm-no');
        const modalStatsClose = document.getElementById('modal-stats-close');
        const modalSurrenderYes = document.getElementById('modal-surrender-yes');
        const modalSurrenderNo = document.getElementById('modal-surrender-no');
        const leaderboardBody = document.getElementById('leaderboard-body'); 
        
        let gameBoard = ['', '', '', '', ['', '', '', '', ''], '', '', '', ''];
        let currentPlayer = 'X'; 
        let gameActive = true; 
        let moveCount = 0; 
        let gameStartTime = null; 
        let timerInterval = null; 
        let starterPlayer = 'O'; 
        let currentDifficulty = 'ideal'; 
        
        let symbols = { 'X': 'X', 'O': 'O' }; 
        let score = { X: 0, Draw: 0, O: 0 }; 
        let unbeatableStreak = 0; 
        let leaderBoard = []; 
        
        const PLAYER_MAP = { 'X': 'X_P', 'O': 'O_P' }; 
        const AI_PLAYER = 'O';
        const HUMAN_PLAYER = 'X';
        const BOT_DELAY = 800; 

        const cellNames = { 
            0: '–í–µ—Ä—Ö–Ω–∏–π –õ–µ–≤—ã–π', 1: '–í–µ—Ä—Ö–Ω–∏–π –¶–µ–Ω—Ç—Ä', 2: '–í–µ—Ä—Ö–Ω–∏–π –ü—Ä–∞–≤—ã–π',
            3: '–°—Ä–µ–¥–Ω–∏–π –õ–µ–≤—ã–π', 4: '–¶–µ–Ω—Ç—Ä', 5: '–°—Ä–µ–¥–Ω–∏–π –ü—Ä–∞–≤—ã–π',
            6: '–ù–∏–∂–Ω–∏–π –õ–µ–≤—ã–π', 7: '–ù–∏–∂–Ω–∏–π –¶–µ–Ω—Ç—Ä', 8: '–ù–∏–∂–Ω–∏–π –ü—Ä–∞–≤—ã–π',
        };
        
        const winningConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], 
            [0, 3, 6], [1, 4, 7], [2, 5, 8], 
            [0, 4, 8], [2, 4, 6]             
        ];

        // --- –ó–í–£–ö–û–í–´–ï –≠–§–§–ï–ö–¢–´ ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, duration, type, volume = 0.5) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = type; 
            oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start();
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + duration);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // --- –¢–ê–ô–ú–ï–† ---
        function startTimer() {
            gameStartTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (gameActive) {
                    const elapsed = (Date.now() - gameStartTime) / 1000;
                    document.getElementById('time-counter').textContent = `–í—Ä–µ–º—è: ${elapsed.toFixed(1)}s`;
                }
            }, 100);
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
        }

        // --- –õ–û–ì–ò–ö–ê –ò–ò (Minimax, Medium, Hard, Random) ---
        
        function getAvailableMoves(board) {
            return board
                .map((val, index) => (val === '' ? index : null))
                .filter(index => index !== null);
        }
        
        function checkWin(board, player) {
            for (const condition of winningConditions) {
                const [a, b, c] = condition;
                if (board[a] === player && board[b] === player && board[c] === player) {
                    return condition; 
                }
            }
            return null;
        }
        
        function findRandomMove(availableMoves) {
            const randomIndex = Math.floor(Math.random() * availableMoves.length);
            return availableMoves[randomIndex];
        }

        function findWinningOrBlockingMove(board, player) {
            // –ò—â–µ—Ç –≤—ã–∏–≥—Ä—ã—à–Ω—ã–π –∏–ª–∏ –±–ª–æ–∫–∏—Ä—É—é—â–∏–π —Ö–æ–¥ –¥–ª—è 'player'
            for (const index of getAvailableMoves(board)) {
                let tempBoard = [...board];
                tempBoard[index] = player;
                if (checkWin(tempBoard, player)) {
                    return index;
                }
            }
            return null;
        }

        function findMediumMove(availableMoves) {
            // 1. –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–∏–≥—Ä–∞—Ç—å (–¥–ª—è AI_PLAYER = 'O')
            let move = findWinningOrBlockingMove(gameBoard, AI_PLAYER);
            if (move !== null) return move;

            // 2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ (–¥–ª—è HUMAN_PLAYER = 'X')
            move = findWinningOrBlockingMove(gameBoard, HUMAN_PLAYER);
            if (move !== null) return move;
            
            // 3. –ó–∞–Ω—è—Ç—å —Ü–µ–Ω—Ç—Ä (–∏–Ω–¥–µ–∫—Å 4)
            if (gameBoard[4] === '') return 4;

            // 4. –°–ª—É—á–∞–π–Ω—ã–π —Ö–æ–¥
            return findRandomMove(availableMoves);
        }

        function findHardMove(availableMoves) {
            // 1. –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–∏–≥—Ä–∞—Ç—å (–¥–ª—è AI_PLAYER)
            let move = findWinningOrBlockingMove(gameBoard, AI_PLAYER);
            if (move !== null) return move;

            // 2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ (–¥–ª—è HUMAN_PLAYER)
            move = findWinningOrBlockingMove(gameBoard, HUMAN_PLAYER);
            if (move !== null) return move;

            // 3. –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Ö–æ–¥—ã (—Ü–µ–Ω—Ç—Ä, —É–≥–ª—ã)
            const strategicMoves = [4, 0, 2, 6, 8]; 
            for (const index of strategicMoves) {
                if (gameBoard[index] === '' && availableMoves.includes(index)) {
                    return index;
                }
            }

            // 4. –°–ª—É—á–∞–π–Ω—ã–π —Ö–æ–¥
            return findRandomMove(availableMoves);
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø MINIMAX (–¥–ª—è –ù–ï–†–ï–ê–õ–¨–ù–û–ì–û —É—Ä–æ–≤–Ω—è)
        function minimax(newBoard, player) {
            const availableMoves = getAvailableMoves(newBoard);
            const winX = checkWin(newBoard, HUMAN_PLAYER);
            const winO = checkWin(newBoard, AI_PLAYER);

            // –ë–∞–∑–æ–≤—ã–µ —Å–ª—É—á–∞–∏ (–û—Ü–µ–Ω–∫–∞)
            if (winO) return { score: 10 }; 
            if (winX) return { score: -10 }; 
            if (availableMoves.length === 0) return { score: 0 }; 
            
            const moves = [];
            
            // –ò–¢–ï–†–ê–¶–ò–Ø
            for (const index of availableMoves) { 
                const move = {};
                move.index = index;
                newBoard[index] = player; 

                let result;
                if (player === AI_PLAYER) {
                    // –†–µ–∫—É—Ä—Å–∏—è –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ (–ò–≥—Ä–æ–∫)
                    result = minimax(newBoard, HUMAN_PLAYER);
                    move.score = result.score;
                } else {
                    // –†–µ–∫—É—Ä—Å–∏—è –¥–ª—è –º–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏–∏ (–ë–æ—Ç)
                    result = minimax(newBoard, AI_PLAYER);
                    move.score = result.score;
                }
                newBoard[index] = ''; // –û—Ç–º–µ–Ω–∞ —Ö–æ–¥–∞
                moves.push(move);
            }

            // –ü–û–ò–°–ö –õ–£–ß–®–ï–ì–û –•–û–î–ê
            let bestMove = null;
            
            if (player === AI_PLAYER) {
                // –ë–æ—Ç (AI_PLAYER) –º–∞–∫—Å–∏–º–∏–∑–∏—Ä—É–µ—Ç
                let bestScore = -Infinity;
                for (let i = 0; i < moves.length; i++) {
                    if (moves[i].score > bestScore) {
                        bestScore = moves[i].score;
                        bestMove = moves[i];
                    }
                }
            } else {
                // –ò–≥—Ä–æ–∫ (HUMAN_PLAYER) –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç
                let bestScore = Infinity;
                for (let i = 0; i < moves.length; i++) {
                    if (moves[i].score < bestScore) {
                        bestScore = moves[i].score;
                        bestMove = moves[i];
                    }
                }
            }
            return bestMove; 
        }

        function findStrategicMove(availableMoves) {
            const move = minimax([...gameBoard], AI_PLAYER); 
            // –ï—Å–ª–∏ minimax –Ω–µ –Ω–∞—à–µ–ª —Ö–æ–¥–∞ (—á–µ–≥–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å, –µ—Å–ª–∏ availableMoves > 0), –±–µ—Ä–µ–º —Å–ª—É—á–∞–π–Ω—ã–π
            return move ? move.index : findRandomMove(availableMoves);
        }

        // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

        function updateLeaderBoard(time) { 
            leaderBoard.push(time);
            leaderBoard.sort((a, b) => a - b); 
            leaderBoard = leaderBoard.slice(0, 3); 
            localStorage.setItem('tictactoeLeaderBoard', JSON.stringify(leaderBoard));
            renderLeaderBoard();
        }
        
        function renderLeaderBoard() { 
            leaderboardBody.innerHTML = '';
            if (leaderBoard.length === 0) {
                 leaderboardBody.innerHTML = '<tr><td colspan="2">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤</td></tr>';
                 return;
            }
            leaderBoard.forEach((time, index) => {
                const row = leaderboardBody.insertRow();
                const rankCell = row.insertCell();
                const timeCell = row.insertCell();
                rankCell.textContent = `#${index + 1}`;
                timeCell.textContent = `${time.toFixed(1)}s`;
                timeCell.classList.add('leaderboard-time');
            });
        }
        
        function updateScoreDisplay() {
            scoreDisplay.innerHTML = `–°—á–µ—Ç: <span class="score-x">${score.X}</span> - <span class="score-draw">${score.Draw}</span> - <span class="score-o">${score.O}</span>`;
            
            let streakMsg = `–°–µ—Ä–∏—è –±–µ–∑ –ø–æ—Ä–∞–∂–µ–Ω–∏–π: ${unbeatableStreak}`;
            if (currentDifficulty === 'ideal') {
                streakMsg = `–°–µ—Ä–∏—è –±–µ–∑ –ø–æ–±–µ–¥ –Ω–∞–¥ –±–æ—Ç–æ–º: ${unbeatableStreak}`; 
            }
            unbeatableDisplay.textContent = streakMsg;
        }
        
        function updateStatsModal() { 
            document.getElementById('stats-win').textContent = score.X;
            document.getElementById('stats-draw').textContent = score.Draw;
            document.getElementById('stats-lose').textContent = score.O;
            
            let streakMsg = `–°–µ—Ä–∏—è –±–µ–∑ –ø–æ—Ä–∞–∂–µ–Ω–∏–π: ${unbeatableStreak}`;
            if (currentDifficulty === 'ideal') {
                streakMsg = `–°–µ—Ä–∏—è –±–µ–∑ –ø–æ–±–µ–¥ –Ω–∞–¥ –±–æ—Ç–æ–º: ${unbeatableStreak}`;
            }
            document.getElementById('stats-unbeatable').textContent = streakMsg;
            
            renderLeaderBoard();
            statsModal.style.display = 'flex';
        }

        function updateLog(player, index) {
            const newLogEntry = document.createElement('li');
            const playerName = player === 'X' ? '–ò–≥—Ä–æ–∫' : '–ë–æ—Ç';
            const logClass = player === 'X' ? 'log-x' : 'log-o';
            
            newLogEntry.innerHTML = `<span class="${logClass}">${playerName}</span> –ø–æ—Å—Ç–∞–≤–∏–ª(–∞) –≤ <strong>${cellNames[index]}</strong>`;
            logList.appendChild(newLogEntry);
            logList.scrollTop = logList.scrollHeight; 
        }

        function updateInfoBar(player) {
            if (!gameActive) {
                playerIndicator.textContent = '–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê';
                playerIndicator.className = '';
                return;
            }
            
            const difficultyName = difficultySelect.options[difficultySelect.selectedIndex].text;
            playerIndicator.textContent = `–•–û–î: ${symbols[player]} | ${difficultyName}`;
            playerIndicator.className = player === 'X' ? 'player-x-turn' : 'player-o-turn';
            
            const ghostSymbol = symbols[player];
            cells.forEach(cell => {
                if (!cell.getAttribute('data-player')) {
                    cell.setAttribute('data-player-symbol', ghostSymbol);
                }
            });
        }

        // --- –õ–û–ì–ò–ö–ê –•–û–î–ê ---

        function handleCellClick(clickedCellEvent) {
            if (!gameActive || currentPlayer === 'O') return;

            const clickedCell = clickedCellEvent.target;
            const clickedCellIndex = parseInt(clickedCell.getAttribute('data-index'));

            if (gameBoard[clickedCellIndex] !== '') return;

            makeMove(clickedCell, clickedCellIndex, currentPlayer);
            if (checkForWinOrDraw()) return;

            currentPlayer = 'O';
            updateInfoBar(currentPlayer);
            messageDisplay.textContent = `–•–æ–¥ –±–æ—Ç–∞ (${symbols[AI_PLAYER]})...`;
            setTimeout(botTurn, 100); 
        }

        function makeMove(cell, index, player) {
            gameBoard[index] = player;
            cell.textContent = symbols[player]; 
            cell.setAttribute('data-player', PLAYER_MAP[player]); 
            cell.removeAttribute('data-player-symbol'); 
            
            cell.classList.remove('flash');
            void cell.offsetWidth; 
            cell.classList.add('flash');
            
            playSound(500, 0.1, 'sine', 0.8);
            
            moveCount++;
            updateLog(player, index);
            document.getElementById('move-counter').textContent = `–•–æ–¥: ${moveCount}`;
        }


        function botTurn() {
            progressBarContainer.style.display = 'block'; 
            progressBar.style.width = '10%'; 
            
            const availableMoves = getAvailableMoves(gameBoard);
            if (availableMoves.length === 0) return; 

            let botMoveIndex = null;
            let currentDelay = BOT_DELAY;

            if (moveCount === 0 && starterPlayer === 'O') {
                currentDelay = BOT_DELAY + 400; 
            }
            
            progressBar.style.transitionDuration = `${currentDelay}ms`;
            progressBar.style.width = '90%'; 
            
            setTimeout(() => {
                // –í—ã–±–æ—Ä —Ö–æ–¥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                switch (currentDifficulty) {
                    case 'random':
                        botMoveIndex = findRandomMove(availableMoves);
                        break;
                    case 'medium':
                        botMoveIndex = findMediumMove(availableMoves);
                        break;
                    case 'hard':
                        botMoveIndex = findHardMove(availableMoves);
                        break;
                    case 'ideal':
                    default:
                        botMoveIndex = findStrategicMove(availableMoves);
                        break;
                }

                if (botMoveIndex !== null) {
                    const botCell = cells[botMoveIndex];
                    makeMove(botCell, botMoveIndex, currentPlayer);
                    checkForWinOrDraw();
                }

                progressBar.style.width = '100%'; 
                setTimeout(() => {
                    progressBarContainer.style.display = 'none';
                    progressBar.style.transitionDuration = '0s'; 
                    progressBar.style.width = '0%';
                }, 100);


                if (gameActive) {
                    currentPlayer = 'X';
                    updateInfoBar(currentPlayer);
                    messageDisplay.textContent = `–í–∞—à —Ö–æ–¥ (${symbols[HUMAN_PLAYER]})`;
                }
            }, currentDelay); 
        }
        
        function endGame(winner) {
            stopTimer();
            gameActive = false;
            const timeElapsed = (Date.now() - gameStartTime) / 1000;
            
            if (winner === 'X') {
                score.X++; 
                unbeatableStreak++; 
                updateLeaderBoard(timeElapsed); 
                messageDisplay.textContent = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏! üèÜ –í—Ä–µ–º—è: ${timeElapsed.toFixed(1)}s`;
                messageDisplay.classList.add('status-win');
                playSound(440, 0.2, 'square', 0.8);
                setTimeout(() => playSound(660, 0.3, 'square', 0.8), 100);
            } else if (winner === 'O') {
                score.O++; 
                unbeatableStreak = 0; 
                
                let winMsg = `–ë–æ—Ç (${difficultySelect.options[difficultySelect.selectedIndex].text}) –≤—ã–∏–≥—Ä–∞–ª. ü§ñ`;
                if (currentDifficulty === 'ideal') {
                    winMsg = `–ë–æ—Ç (–ù–µ—Ä–µ–∞–ª—å–Ω—ã–π) –≤—ã–∏–≥—Ä–∞–ª. ü§ñ –¢–∞–∫ –∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å.`;
                }
                messageDisplay.textContent = winMsg;
                messageDisplay.classList.add('status-lose'); 
                playSound(80, 0.8, 'square', 0.8); 
            } else if (winner === 'Draw') {
                score.Draw++; 
                unbeatableStreak++; 
                
                let drawMsg = '–ù–∏—á—å—è! ü§ù';
                if (currentDifficulty === 'ideal') {
                    drawMsg = '–ù–∏—á—å—è! ü§ù (–í—ã —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å —Å –ù–µ—Ä–µ–∞–ª—å–Ω—ã–º –ë–æ—Ç–æ–º!)';
                    messageDisplay.classList.add('status-impossible'); 
                }
                messageDisplay.textContent = drawMsg;
                messageDisplay.classList.add('status-draw');
                playSound(100, 0.5, 'sawtooth', 0.6);
            }

            gameBoardElement.classList.add('vibrate');
            
            updateScoreDisplay();
            
            cells.forEach(cell => cell.style.pointerEvents = 'none');
            updateInfoBar(currentPlayer); 
        }


        function checkForWinOrDraw() {
            const winningLine = checkWin(gameBoard, currentPlayer);

            if (winningLine) {
                endGame(currentPlayer);
                winningLine.forEach(index => cells[index].classList.add('win'));
                return true;
            }

            if (!gameBoard.includes('')) {
                endGame('Draw');
                return true;
            }
            return false;
        }
        
        function handleSurrender() { 
            confirmSurrenderModal.style.display = 'none';
            if (gameActive) {
                endGame('O'); 
            }
        }


        // --- –õ–û–ì–ò–ö–ê –°–ë–†–û–°–ê –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ---
        
        function resetGame(resetScore = false) {
            stopTimer();
            confirmResetModal.style.display = 'none';
            confirmSurrenderModal.style.display = 'none';
            statsModal.style.display = 'none';
            
            if (resetScore) { 
                score = { X: 0, Draw: 0, O: 0 };
                unbeatableStreak = 0; 
                leaderBoard = []; 
                localStorage.removeItem('tictactoeLeaderBoard');
            }

            // –†–æ—Ç–∞—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            starterPlayer = starterPlayer === 'X' ? 'O' : 'X'; 
            currentPlayer = starterPlayer;
            currentDifficulty = difficultySelect.value; 
            
            gameBoard = ['', '', '', '', '', '', '', '', ''];
            gameActive = true; 
            moveCount = 0; 
            logList.innerHTML = ''; 
            document.getElementById('move-counter').textContent = `–•–æ–¥: 0`;
            document.getElementById('time-counter').textContent = `–í—Ä–µ–º—è: 0.0s`;

            const difficultyName = difficultySelect.options[difficultySelect.selectedIndex].text;
            messageDisplay.textContent = `–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å. –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${difficultyName}. –ü–µ—Ä–≤—ã–º —Ö–æ–¥–∏—Ç: ${symbols[currentPlayer]}`;
            messageDisplay.classList.remove('status-win', 'status-draw', 'status-lose', 'status-impossible');

            gameBoardElement.classList.remove('vibrate');
            
            // –£–¥–∞–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ fade-in. –ü–æ–ª–µ —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º–æ –±–ª–∞–≥–æ–¥–∞—Ä—è CSS.

            updateScoreDisplay(); 
            updateInfoBar(currentPlayer);
            startTimer();

            cells.forEach(cell => {
                cell.textContent = '';
                cell.removeAttribute('data-player');
                cell.removeAttribute('data-player-symbol');
                cell.classList.remove('win', 'flash'); 
                cell.style.pointerEvents = 'auto'; 
                
                cell.setAttribute('data-player-symbol', symbols[currentPlayer]);
            });
            
            if (currentPlayer === 'O') {
                messageDisplay.textContent = `–•–æ–¥ –±–æ—Ç–∞ (${symbols[AI_PLAYER]}) –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ "${difficultyName}"...`;
                setTimeout(botTurn, 100);
            }
        }

        // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ---
        
        function handleResetPrompt() {
            if (moveCount > 0 && gameActive) {
                confirmResetModal.style.display = 'flex';
            } else {
                resetGame();
            }
        }
        
        function handleSurrenderPrompt() { 
            if (gameActive && moveCount > 0) {
                confirmSurrenderModal.style.display = 'flex';
            }
        }

        cells.forEach(cell => cell.addEventListener('click', handleCellClick));
        resetButton.addEventListener('click', handleResetPrompt);
        resetScoreButton.addEventListener('click', () => resetGame(true));
        surrenderButton.addEventListener('click', handleSurrenderPrompt); 
        scoreDisplay.addEventListener('click', updateStatsModal); 
        
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –°–õ–û–ñ–ù–û–°–¢–ò
        difficultySelect.addEventListener('change', () => {
            currentDifficulty = difficultySelect.value;
            // –ü—Ä–∏ —Å–º–µ–Ω–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –Ω–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É
            handleResetPrompt(); 
        });


        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        modalConfirmYes.addEventListener('click', () => resetGame(false));
        modalConfirmNo.addEventListener('click', () => confirmResetModal.style.display = 'none');
        modalStatsClose.addEventListener('click', () => statsModal.style.display = 'none');
        modalSurrenderYes.addEventListener('click', handleSurrender); 
        modalSurrenderNo.addEventListener('click', () => confirmSurrenderModal.style.display = 'none');

        // –¢–µ–º–∞
        function toggleTheme() {
            const isLight = body.classList.toggle('light-theme');
            themeToggle.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
        }
        themeToggle.addEventListener('click', toggleTheme);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function init() {
            const storedLeaderBoard = localStorage.getItem('tictactoeLeaderBoard');
            if (storedLeaderBoard) {
                leaderBoard = JSON.parse(storedLeaderBoard);
            }
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ù–µ—Ä–µ–∞–ª—å–Ω—ã–π/–ò–¥–µ–∞–ª—å–Ω—ã–π)
            difficultySelect.value = 'ideal';
            // –°–±—Ä–æ—Å –∏–≥—Ä—ã –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            resetGame(false); 
        }
        init();
        
    </script>
</body>
</html>